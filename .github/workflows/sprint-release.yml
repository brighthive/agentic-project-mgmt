name: Sprint Release Automation

on:
  workflow_dispatch:
    inputs:
      sprint_number:
        description: 'Sprint number (e.g., 3)'
        required: true
        type: number
      sprint_name:
        description: 'Sprint name in Jira (e.g., "Sprint 3 üçé")'
        required: true
        type: string
      since_date:
        description: 'Start date (YYYY-MM-DD)'
        required: true
        type: string
      until_date:
        description: 'End date (YYYY-MM-DD)'
        required: true
        type: string
      create_repo_releases:
        description: 'Create releases on code repos'
        required: false
        type: boolean
        default: true
      post_to_slack:
        description: 'Post to Slack'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: read

env:
  SPRINT_NUM: ${{ github.event.inputs.sprint_number }}
  SPRINT_NAME: ${{ github.event.inputs.sprint_name }}
  SINCE_DATE: ${{ github.event.inputs.since_date }}
  UNTIL_DATE: ${{ github.event.inputs.until_date }}

jobs:
  # ===========================================
  # Job 1: Collect data from all repos
  # ===========================================
  collect-repo-data:
    runs-on: ubuntu-latest
    outputs:
      platform_core_prs: ${{ steps.platform-core.outputs.prs }}
      platform_core_lines: ${{ steps.platform-core.outputs.lines }}
      webapp_prs: ${{ steps.webapp.outputs.prs }}
      webapp_lines: ${{ steps.webapp.outputs.lines }}
      brightbot_prs: ${{ steps.brightbot.outputs.prs }}
      brightbot_lines: ${{ steps.brightbot.outputs.lines }}
    steps:
      - name: Collect brighthive-platform-core PRs
        id: platform-core
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          PRS=$(gh pr list --repo brighthive/brighthive-platform-core \
            --state merged \
            --search "merged:${{ env.SINCE_DATE }}..${{ env.UNTIL_DATE }}" \
            --limit 100 \
            --json number,title,author,additions,deletions,mergedAt)
          echo "prs<<EOF" >> $GITHUB_OUTPUT
          echo "$PRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          LINES=$(echo "$PRS" | jq '[.[] | .additions + .deletions] | add // 0')
          echo "lines=$LINES" >> $GITHUB_OUTPUT

      - name: Collect brighthive-webapp PRs
        id: webapp
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          PRS=$(gh pr list --repo brighthive/brighthive-webapp \
            --state merged \
            --search "merged:${{ env.SINCE_DATE }}..${{ env.UNTIL_DATE }}" \
            --limit 100 \
            --json number,title,author,additions,deletions,mergedAt)
          echo "prs<<EOF" >> $GITHUB_OUTPUT
          echo "$PRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          LINES=$(echo "$PRS" | jq '[.[] | .additions + .deletions] | add // 0')
          echo "lines=$LINES" >> $GITHUB_OUTPUT

      - name: Collect brightbot PRs
        id: brightbot
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          PRS=$(gh pr list --repo brighthive/brightbot \
            --state merged \
            --search "merged:${{ env.SINCE_DATE }}..${{ env.UNTIL_DATE }}" \
            --limit 100 \
            --json number,title,author,additions,deletions,mergedAt)
          echo "prs<<EOF" >> $GITHUB_OUTPUT
          echo "$PRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          LINES=$(echo "$PRS" | jq '[.[] | .additions + .deletions] | add // 0')
          echo "lines=$LINES" >> $GITHUB_OUTPUT

  # ===========================================
  # Job 2: Collect Jira tickets
  # ===========================================
  collect-jira-data:
    runs-on: ubuntu-latest
    outputs:
      tickets_json: ${{ steps.jira.outputs.tickets }}
      ticket_count: ${{ steps.jira.outputs.count }}
      points_total: ${{ steps.jira.outputs.points }}
    steps:
      - name: Fetch Jira Sprint Tickets
        id: jira
        env:
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
        run: |
          RESPONSE=$(curl -s -u "$JIRA_USER:$JIRA_TOKEN" \
            -X POST "https://brighthiveio.atlassian.net/rest/api/3/search/jql" \
            -H "Content-Type: application/json" \
            -d "{\"jql\":\"project = BH AND sprint = \\\"${{ env.SPRINT_NAME }}\\\" AND status = Done\", \"fields\":[\"key\",\"summary\",\"issuetype\",\"assignee\",\"customfield_10016\"], \"maxResults\":200}")

          TICKETS=$(echo "$RESPONSE" | jq '[.issues[] | {key: .key, summary: .fields.summary, type: .fields.issuetype.name, assignee: (.fields.assignee.displayName // "Unassigned"), points: (.fields.customfield_10016 // 0)}]')
          COUNT=$(echo "$TICKETS" | jq 'length')
          POINTS=$(echo "$TICKETS" | jq '[.[].points] | add // 0')

          echo "tickets<<EOF" >> $GITHUB_OUTPUT
          echo "$TICKETS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "points=$POINTS" >> $GITHUB_OUTPUT

  # ===========================================
  # Job 3: Generate Release Notes
  # ===========================================
  generate-release-notes:
    runs-on: ubuntu-latest
    needs: [collect-repo-data, collect-jira-data]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Sprint Directory
        run: mkdir -p jira/sprint/${{ env.SPRINT_NUM }}

      - name: Generate Technical Release Notes
        run: |
          cat > jira/sprint/${{ env.SPRINT_NUM }}/RELEASE_NOTES.md << 'RELEASE_EOF'
          # Sprint ${{ env.SPRINT_NUM }} Release Notes

          **Sprint:** ${{ env.SPRINT_NAME }}
          **Period:** ${{ env.SINCE_DATE }} to ${{ env.UNTIL_DATE }}
          **Released:** $(date +%Y-%m-%d)

          ---

          ## Summary

          | Metric | Value |
          |--------|-------|
          | Tickets Completed | ${{ needs.collect-jira-data.outputs.ticket_count }} |
          | Story Points | ${{ needs.collect-jira-data.outputs.points_total }} |
          | PRs Merged | TBD |
          | Lines Changed | TBD |

          ---

          ## Repository Changes

          ### brighthive-platform-core
          - Lines changed: ${{ needs.collect-repo-data.outputs.platform_core_lines }}

          ### brighthive-webapp
          - Lines changed: ${{ needs.collect-repo-data.outputs.webapp_lines }}

          ### brightbot
          - Lines changed: ${{ needs.collect-repo-data.outputs.brightbot_lines }}

          ---

          ## Completed Tickets

          RELEASE_EOF

          # Add tickets from JSON
          echo '${{ needs.collect-jira-data.outputs.tickets_json }}' | jq -r '.[] | "- **[\(.key)]** \(.summary) (@\(.assignee))"' >> jira/sprint/${{ env.SPRINT_NUM }}/RELEASE_NOTES.md

      - name: Generate GTM/Marketing Release Notes
        run: |
          cat > jira/sprint/${{ env.SPRINT_NUM }}/MARKETING_RELEASE_NOTES.md << 'MARKETING_EOF'
          # Sprint ${{ env.SPRINT_NUM }} - What's New üöÄ

          **Release Date:** $(date +%Y-%m-%d)

          ---

          ## Highlights for Customers

          <!--
          INSTRUCTIONS FOR GTM TEAM:
          1. Review the completed tickets below
          2. Identify customer-facing features
          3. Write 2-3 bullet points in customer-friendly language
          4. Add screenshots/GIFs if available
          -->

          ### New Features
          - [ ] TODO: Add customer-facing features

          ### Improvements
          - [ ] TODO: Add improvements

          ### Bug Fixes
          - [ ] TODO: Add notable bug fixes

          ---

          ## Engineering Stats (for investors)

          | Metric | Value |
          |--------|-------|
          | Features Delivered | ${{ needs.collect-jira-data.outputs.ticket_count }} tickets |
          | Story Points | ${{ needs.collect-jira-data.outputs.points_total }} pts |
          | Code Changes | ${{ needs.collect-repo-data.outputs.platform_core_lines }} + ${{ needs.collect-repo-data.outputs.webapp_lines }} + ${{ needs.collect-repo-data.outputs.brightbot_lines }} lines |
          | Team Velocity | ~X pts/week |

          ---

          ## Technical Tickets (Reference)

          MARKETING_EOF

          # Add tickets grouped by type
          echo '${{ needs.collect-jira-data.outputs.tickets_json }}' | jq -r 'group_by(.type) | .[] | "### \(.[0].type)\n" + (map("- \(.key): \(.summary)") | join("\n")) + "\n"' >> jira/sprint/${{ env.SPRINT_NUM }}/MARKETING_RELEASE_NOTES.md

      - name: Commit Release Notes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git add jira/sprint/${{ env.SPRINT_NUM }}/

          if ! git diff --staged --quiet; then
            git commit -m "docs(sprint): generate Sprint ${{ env.SPRINT_NUM }} release notes"
            git push
          fi

  # ===========================================
  # Job 4: Create releases on code repos
  # ===========================================
  create-repo-releases:
    runs-on: ubuntu-latest
    needs: [collect-repo-data, generate-release-notes]
    if: ${{ github.event.inputs.create_repo_releases == 'true' }}
    strategy:
      matrix:
        repo: [brighthive-platform-core, brighthive-webapp, brightbot]
    steps:
      - name: Create Release on ${{ matrix.repo }}
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          TAG="sprint-${{ env.SPRINT_NUM }}"

          # Get merged PRs for changelog
          PRS=$(gh pr list --repo brighthive/${{ matrix.repo }} \
            --state merged \
            --search "merged:${{ env.SINCE_DATE }}..${{ env.UNTIL_DATE }}" \
            --limit 100 \
            --json number,title,author)

          # Generate changelog
          CHANGELOG="## Sprint ${{ env.SPRINT_NUM }} Release\n\n"
          CHANGELOG+="**Period:** ${{ env.SINCE_DATE }} to ${{ env.UNTIL_DATE }}\n\n"
          CHANGELOG+="### Changes\n\n"
          CHANGELOG+=$(echo "$PRS" | jq -r '.[] | "- #\(.number) \(.title) (@\(.author.login))"')

          # Create tag and release
          gh release create "$TAG" \
            --repo brighthive/${{ matrix.repo }} \
            --title "Sprint ${{ env.SPRINT_NUM }}" \
            --notes "$CHANGELOG" \
            --latest || echo "Release may already exist"

  # ===========================================
  # Job 5: Post to Slack
  # ===========================================
  post-to-slack:
    runs-on: ubuntu-latest
    needs: [collect-jira-data, generate-release-notes]
    if: ${{ github.event.inputs.post_to_slack == 'true' }}
    steps:
      - name: Post Sprint Summary to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {\"type\": \"plain_text\", \"text\": \"üöÄ Sprint ${{ env.SPRINT_NUM }} Complete!\"}
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Tickets:* ${{ needs.collect-jira-data.outputs.ticket_count }}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Points:* ${{ needs.collect-jira-data.outputs.points_total }}\"}
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {\"type\": \"mrkdwn\", \"text\": \"<https://github.com/brighthive/agentic-project-mgmt/blob/master/jira/sprint/${{ env.SPRINT_NUM }}/RELEASE_NOTES.md|View Release Notes>\"}
                }
              ]
            }"
