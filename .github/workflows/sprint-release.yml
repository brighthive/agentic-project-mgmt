name: Sprint Release Automation

on:
  push:
    tags:
      - 'sprint-*'  # Triggers on tags like sprint-1, sprint-2, etc.
  workflow_dispatch:
    inputs:
      sprint_number:
        description: 'Sprint number'
        required: true
        type: number
      since_date:
        description: 'Start date (YYYY-MM-DD)'
        required: false
        type: string
      until_date:
        description: 'End date (YYYY-MM-DD)'
        required: false
        type: string
      post_to_slack:
        description: 'Post to Slack'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log

      - name: Extract sprint number from tag
        id: extract_sprint
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            SPRINT_NUM=$(echo ${{ github.ref }} | sed 's/refs\/tags\/sprint-//')
            echo "sprint_number=$SPRINT_NUM" >> $GITHUB_OUTPUT
          else
            echo "sprint_number=${{ github.event.inputs.sprint_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate release notes
        id: generate
        run: |
          cd project/sprint/scripts

          # Build command
          CMD="python generate_release_notes.py --sprint ${{ steps.extract_sprint.outputs.sprint_number }}"

          # Add optional date parameters
          if [ -n "${{ github.event.inputs.since_date }}" ]; then
            CMD="$CMD --since ${{ github.event.inputs.since_date }}"
          fi

          if [ -n "${{ github.event.inputs.until_date }}" ]; then
            CMD="$CMD --until ${{ github.event.inputs.until_date }}"
          fi

          # Run generation
          $CMD

          # Set output paths
          SPRINT_DIR="../sprint-${{ steps.extract_sprint.outputs.sprint_number }}"
          echo "sprint_dir=$SPRINT_DIR" >> $GITHUB_OUTPUT
          echo "technical_notes=$SPRINT_DIR/SPRINT_${{ steps.extract_sprint.outputs.sprint_number }}_RELEASE_NOTES.md" >> $GITHUB_OUTPUT
          echo "marketing_notes=$SPRINT_DIR/SPRINT_${{ steps.extract_sprint.outputs.sprint_number }}_MARKETING_RELEASE_NOTES.md" >> $GITHUB_OUTPUT

      - name: Commit release notes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git add project/sprint/sprint-${{ steps.extract_sprint.outputs.sprint_number }}/

          if ! git diff --staged --quiet; then
            git commit -m "docs(sprint): generate Sprint ${{ steps.extract_sprint.outputs.sprint_number }} release notes"
            git push
          else
            echo "No changes to commit"
          fi

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Sprint ${{ steps.extract_sprint.outputs.sprint_number }} Release
          body_path: ${{ steps.generate.outputs.marketing_notes }}
          draft: false
          prerelease: false

  post-to-slack:
    runs-on: ubuntu-latest
    needs: generate-release-notes
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.post_to_slack == 'true') ||
      (github.event_name == 'push' && secrets.SLACK_WEBHOOK_URL != '')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Post to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          cd project/sprint/scripts
          python post_to_slack.py --sprint ${{ steps.extract_sprint.outputs.sprint_number }}

      - name: Slack notification
        if: failure()
        run: |
          echo "⚠️ Failed to post to Slack. Check SLACK_WEBHOOK_URL secret is configured."
