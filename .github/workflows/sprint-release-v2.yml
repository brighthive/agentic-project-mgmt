name: Sprint Release Automation
# Generates release notes, updates changelogs, posts to Slack

on:
  workflow_dispatch:
    inputs:
      sprint_number:
        description: 'Sprint number (e.g., 3)'
        required: true
        type: number
      sprint_name:
        description: 'Sprint name in Jira (e.g., "Sprint 3 ðŸŽ")'
        required: true
        type: string
      since_date:
        description: 'Start date (YYYY-MM-DD)'
        required: true
        type: string
      until_date:
        description: 'End date (YYYY-MM-DD)'
        required: true
        type: string
      update_repo_changelogs:
        description: 'Update CHANGELOG.md in touched repos'
        required: false
        type: boolean
        default: true
      post_to_slack:
        description: 'Post to Slack'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: read

env:
  SPRINT_NUM: ${{ github.event.inputs.sprint_number }}
  SPRINT_NAME: ${{ github.event.inputs.sprint_name }}
  SINCE_DATE: ${{ github.event.inputs.since_date }}
  UNTIL_DATE: ${{ github.event.inputs.until_date }}

jobs:
  # ===========================================
  # Job 1: Discover repos from Jira ticket links
  # ===========================================
  discover-repos:
    runs-on: ubuntu-latest
    outputs:
      repos_json: ${{ steps.discover.outputs.repos }}
      repos_list: ${{ steps.discover.outputs.repos_list }}
      tickets_json: ${{ steps.discover.outputs.tickets }}
      ticket_count: ${{ steps.discover.outputs.count }}
      points_total: ${{ steps.discover.outputs.points }}
    steps:
      - name: Discover repos from Jira ticket PR links
        id: discover
        env:
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
        run: |
          # Fetch all Done tickets in sprint
          RESPONSE=$(curl -s -u "$JIRA_USER:$JIRA_TOKEN" \
            -X POST "https://brighthiveio.atlassian.net/rest/api/3/search/jql" \
            -H "Content-Type: application/json" \
            -d "{\"jql\":\"project = BH AND sprint = \\\"${{ env.SPRINT_NAME }}\\\" AND status = Done\", \"fields\":[\"key\",\"summary\",\"issuetype\",\"assignee\",\"customfield_10016\"], \"maxResults\":200}")

          TICKETS=$(echo "$RESPONSE" | jq '[.issues[] | {key: .key, id: .id, summary: .fields.summary, type: .fields.issuetype.name, assignee: (.fields.assignee.displayName // "Unassigned"), points: (.fields.customfield_10016 // 0)}]')
          COUNT=$(echo "$TICKETS" | jq 'length')
          POINTS=$(echo "$TICKETS" | jq '[.[].points] | add // 0')

          # Discover repos from ticket PR links
          REPOS=""
          TICKET_REPOS="[]"

          for ISSUE_ID in $(echo "$TICKETS" | jq -r '.[].id'); do
            # Get linked PRs from Jira dev-status API
            PR_DATA=$(curl -s -u "$JIRA_USER:$JIRA_TOKEN" \
              "https://brighthiveio.atlassian.net/rest/dev-status/latest/issue/detail?issueId=${ISSUE_ID}&applicationType=GitHub&dataType=pullrequest")

            # Extract repo names from PR URLs
            PR_REPOS=$(echo "$PR_DATA" | jq -r '.detail[].pullRequests[].url // empty' | \
              sed 's|https://github.com/brighthive/||' | cut -d'/' -f1 | sort -u)

            if [ -n "$PR_REPOS" ]; then
              REPOS="$REPOS $PR_REPOS"
            fi
          done

          # Deduplicate repos
          UNIQUE_REPOS=$(echo "$REPOS" | tr ' ' '\n' | sort -u | grep -v '^$' | tr '\n' ' ')
          REPOS_JSON=$(echo "$UNIQUE_REPOS" | tr ' ' '\n' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "Discovered repos: $UNIQUE_REPOS"
          echo "repos=$REPOS_JSON" >> $GITHUB_OUTPUT
          echo "repos_list=$UNIQUE_REPOS" >> $GITHUB_OUTPUT

          echo "tickets<<EOF" >> $GITHUB_OUTPUT
          echo "$TICKETS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "points=$POINTS" >> $GITHUB_OUTPUT

  # ===========================================
  # Job 2: Collect PR data from discovered repos
  # ===========================================
  collect-repo-data:
    runs-on: ubuntu-latest
    needs: discover-repos
    outputs:
      repo_stats: ${{ steps.collect.outputs.stats }}
      total_lines: ${{ steps.collect.outputs.total_lines }}
      total_prs: ${{ steps.collect.outputs.total_prs }}
    steps:
      - name: Collect PR data from all discovered repos
        id: collect
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
          REPOS: ${{ needs.discover-repos.outputs.repos_list }}
        run: |
          STATS="[]"
          TOTAL_LINES=0
          TOTAL_PRS=0

          for REPO in $REPOS; do
            echo "Collecting data from brighthive/$REPO..."

            PRS=$(gh pr list --repo "brighthive/$REPO" \
              --state merged \
              --search "merged:${{ env.SINCE_DATE }}..${{ env.UNTIL_DATE }}" \
              --limit 100 \
              --json number,title,author,additions,deletions,mergedAt 2>/dev/null || echo "[]")

            PR_COUNT=$(echo "$PRS" | jq 'length')
            LINES=$(echo "$PRS" | jq '[.[] | .additions + .deletions] | add // 0')

            TOTAL_LINES=$((TOTAL_LINES + LINES))
            TOTAL_PRS=$((TOTAL_PRS + PR_COUNT))

            REPO_STAT=$(jq -n \
              --arg repo "$REPO" \
              --argjson prs "$PRS" \
              --argjson lines "$LINES" \
              --argjson count "$PR_COUNT" \
              '{repo: $repo, lines: $lines, pr_count: $count, prs: $prs}')

            STATS=$(echo "$STATS" | jq --argjson stat "$REPO_STAT" '. + [$stat]')
          done

          echo "stats<<EOF" >> $GITHUB_OUTPUT
          echo "$STATS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
          echo "total_prs=$TOTAL_PRS" >> $GITHUB_OUTPUT

  # ===========================================
  # Job 3: Generate Release Notes
  # ===========================================
  generate-release-notes:
    runs-on: ubuntu-latest
    needs: [discover-repos, collect-repo-data]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Sprint Directory
        run: mkdir -p jira/sprint/${{ env.SPRINT_NUM }}

      - name: Generate Technical Release Notes
        env:
          TICKETS_JSON: ${{ needs.discover-repos.outputs.tickets_json }}
          REPO_STATS: ${{ needs.collect-repo-data.outputs.repo_stats }}
          TICKET_COUNT: ${{ needs.discover-repos.outputs.ticket_count }}
          POINTS_TOTAL: ${{ needs.discover-repos.outputs.points_total }}
          TOTAL_PRS: ${{ needs.collect-repo-data.outputs.total_prs }}
          TOTAL_LINES: ${{ needs.collect-repo-data.outputs.total_lines }}
        run: |
          # Generate release notes header
          RELEASE_DATE=$(date +%Y-%m-%d)
          {
            echo "# Sprint $SPRINT_NUM Release Notes"
            echo ""
            echo "**Sprint:** $SPRINT_NAME"
            echo "**Period:** $SINCE_DATE to $UNTIL_DATE"
            echo "**Released:** $RELEASE_DATE"
            echo ""
            echo "---"
            echo ""
            echo "## Summary"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Tickets Completed | $TICKET_COUNT |"
            echo "| Story Points | $POINTS_TOTAL |"
            echo "| PRs Merged | $TOTAL_PRS |"
            echo "| Lines Changed | $TOTAL_LINES |"
            echo ""
            echo "---"
            echo ""
            echo "## Repository Changes"
            echo ""
          } > jira/sprint/$SPRINT_NUM/RELEASE_NOTES.md

          # Add repo stats dynamically
          echo "$REPO_STATS" | jq -r '.[] | "### \(.repo)\n- PRs merged: \(.pr_count)\n- Lines changed: \(.lines)\n"' >> jira/sprint/$SPRINT_NUM/RELEASE_NOTES.md

          {
            echo ""
            echo "---"
            echo ""
            echo "## Completed Tickets"
            echo ""
          } >> jira/sprint/$SPRINT_NUM/RELEASE_NOTES.md

          # Add tickets from JSON
          echo "$TICKETS_JSON" | jq -r '.[] | "- **[\(.key)](https://brighthiveio.atlassian.net/browse/\(.key))** \(.summary) (@\(.assignee))"' >> jira/sprint/$SPRINT_NUM/RELEASE_NOTES.md

          {
            echo ""
            echo "---"
            echo ""
            echo "## Pull Requests by Repository"
            echo ""
          } >> jira/sprint/$SPRINT_NUM/RELEASE_NOTES.md

          echo "$REPO_STATS" | jq -r '.[] | select(.pr_count > 0) | . as $r | "### \(.repo)\n" + (.prs | map("- [#\(.number)](https://github.com/brighthive/\($r.repo)/pull/\(.number)) \(.title) (@\(.author.login))") | join("\n")) + "\n"' >> jira/sprint/$SPRINT_NUM/RELEASE_NOTES.md

      - name: Generate GTM/Marketing Release Notes
        env:
          TICKETS_JSON: ${{ needs.discover-repos.outputs.tickets_json }}
          REPO_STATS: ${{ needs.collect-repo-data.outputs.repo_stats }}
          TICKET_COUNT: ${{ needs.discover-repos.outputs.ticket_count }}
          POINTS_TOTAL: ${{ needs.discover-repos.outputs.points_total }}
          TOTAL_PRS: ${{ needs.collect-repo-data.outputs.total_prs }}
          TOTAL_LINES: ${{ needs.collect-repo-data.outputs.total_lines }}
          REPOS_LIST: ${{ needs.discover-repos.outputs.repos_list }}
        run: |
          REPO_COUNT=$(echo "$REPOS_LIST" | wc -w | tr -d ' ')
          RELEASE_DATE=$(date +%Y-%m-%d)

          {
            echo "# Sprint $SPRINT_NUM - What's New"
            echo ""
            echo "**Release Date:** $RELEASE_DATE"
            echo ""
            echo "---"
            echo ""
            echo "## Highlights for Customers"
            echo ""
            echo "<!--"
            echo "INSTRUCTIONS FOR GTM TEAM:"
            echo "1. Review the completed tickets below"
            echo "2. Identify customer-facing features"
            echo "3. Write 2-3 bullet points in customer-friendly language"
            echo "4. Add screenshots/GIFs if available"
            echo "-->"
            echo ""
            echo "### New Features"
            echo "- [ ] TODO: Add customer-facing features"
            echo ""
            echo "### Improvements"
            echo "- [ ] TODO: Add improvements"
            echo ""
            echo "### Bug Fixes"
            echo "- [ ] TODO: Add notable bug fixes"
            echo ""
            echo "---"
            echo ""
            echo "## Engineering Stats (for investors)"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Features Delivered | $TICKET_COUNT tickets |"
            echo "| Story Points | $POINTS_TOTAL pts |"
            echo "| PRs Merged | $TOTAL_PRS |"
            echo "| Lines Changed | $TOTAL_LINES |"
            echo "| Repos Touched | $REPO_COUNT |"
            echo ""
            echo "---"
            echo ""
            echo "## Repos Modified"
            echo ""
          } > jira/sprint/$SPRINT_NUM/MARKETING_RELEASE_NOTES.md

          echo "$REPO_STATS" | jq -r '.[] | "- **\(.repo)**: \(.pr_count) PRs, \(.lines) lines"' >> jira/sprint/$SPRINT_NUM/MARKETING_RELEASE_NOTES.md

          {
            echo ""
            echo "---"
            echo ""
            echo "## Technical Tickets (Reference)"
            echo ""
          } >> jira/sprint/$SPRINT_NUM/MARKETING_RELEASE_NOTES.md

          # Add tickets grouped by type
          echo "$TICKETS_JSON" | jq -r 'group_by(.type) | .[] | "### \(.[0].type)\n" + (map("- [\(.key)](https://brighthiveio.atlassian.net/browse/\(.key)): \(.summary)") | join("\n")) + "\n"' >> jira/sprint/$SPRINT_NUM/MARKETING_RELEASE_NOTES.md

      - name: Commit Release Notes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git add jira/sprint/${{ env.SPRINT_NUM }}/

          if ! git diff --staged --quiet; then
            git commit -m "docs(sprint): generate Sprint ${{ env.SPRINT_NUM }} release notes"
            git push
          fi

  # ===========================================
  # Job 4: Update CHANGELOG.md in each touched repo
  # ===========================================
  update-repo-changelogs:
    runs-on: ubuntu-latest
    needs: [discover-repos, collect-repo-data, generate-release-notes]
    if: ${{ github.event.inputs.update_repo_changelogs == 'true' }}
    steps:
      - name: Update CHANGELOG.md in All Touched Repos
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
          REPOS: ${{ needs.discover-repos.outputs.repos_list }}
          REPO_STATS: ${{ needs.collect-repo-data.outputs.repo_stats }}
        run: |
          for REPO in $REPOS; do
            echo "Updating CHANGELOG.md in brighthive/$REPO..."

            # Get PR data for this repo from stats
            REPO_DATA=$(echo "$REPO_STATS" | jq --arg r "$REPO" '.[] | select(.repo == $r)')
            PR_COUNT=$(echo "$REPO_DATA" | jq '.pr_count')

            if [ "$PR_COUNT" -eq 0 ]; then
              echo "Skipping $REPO - no PRs"
              continue
            fi

            # Clone the repo
            git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/brighthive/$REPO.git" "/tmp/$REPO"
            cd "/tmp/$REPO"

            # Generate changelog entry
            PR_LINES=$(echo "$REPO_DATA" | jq -r '.prs[] | "- [#\(.number)](https://github.com/brighthive/'"$REPO"'/pull/\(.number)) \(.title) (@\(.author.login))"')

            {
              echo "## Sprint $SPRINT_NUM ($UNTIL_DATE)"
              echo ""
              echo "**Period:** $SINCE_DATE to $UNTIL_DATE"
              echo ""
              echo "### Changes"
              echo ""
              echo "$PR_LINES"
              echo ""
              echo "---"
              echo ""
            } > /tmp/new_entry.md

            # Prepend to CHANGELOG.md (or create if doesn't exist)
            if [ -f CHANGELOG.md ]; then
              cat /tmp/new_entry.md CHANGELOG.md > /tmp/changelog_new.md
              mv /tmp/changelog_new.md CHANGELOG.md
            else
              {
                echo "# Changelog"
                echo ""
              } > /tmp/header.md
              cat /tmp/header.md /tmp/new_entry.md > CHANGELOG.md
            fi

            # Commit and push
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            git add CHANGELOG.md
            git commit -m "docs(changelog): add Sprint ${{ env.SPRINT_NUM }} changes" || echo "No changes to commit"
            git push || echo "Push failed for $REPO"

            cd -
            rm -rf "/tmp/$REPO"
          done

  # ===========================================
  # Job 5: Post to Slack
  # ===========================================
  post-to-slack:
    runs-on: ubuntu-latest
    needs: [discover-repos, collect-repo-data, generate-release-notes]
    if: ${{ github.event.inputs.post_to_slack == 'true' }}
    steps:
      - name: Post Sprint Summary to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPOS: ${{ needs.discover-repos.outputs.repos_list }}
          REPO_STATS: ${{ needs.collect-repo-data.outputs.repo_stats }}
          TICKET_COUNT: ${{ needs.discover-repos.outputs.ticket_count }}
          POINTS_TOTAL: ${{ needs.discover-repos.outputs.points_total }}
          TOTAL_PRS: ${{ needs.collect-repo-data.outputs.total_prs }}
          TOTAL_LINES: ${{ needs.collect-repo-data.outputs.total_lines }}
        run: |
          # Build repo breakdown text
          REPO_BREAKDOWN=$(echo "$REPO_STATS" | jq -r '.[] | "â€¢ *\(.repo)*: \(.pr_count) PRs, \(.lines) lines"' | paste -sd '\n' -)

          # Build JSON payload using jq for proper escaping
          PAYLOAD=$(jq -n \
            --arg sprint_num "$SPRINT_NUM" \
            --arg sprint_name "$SPRINT_NAME" \
            --arg since "$SINCE_DATE" \
            --arg until "$UNTIL_DATE" \
            --arg tickets "$TICKET_COUNT" \
            --arg points "$POINTS_TOTAL" \
            --arg prs "$TOTAL_PRS" \
            --arg lines "$TOTAL_LINES" \
            --arg repos "$REPO_BREAKDOWN" \
            '{
              blocks: [
                {type: "header", text: {type: "plain_text", text: ("ðŸš€ Sprint " + $sprint_num + " Complete!"), emoji: true}},
                {type: "context", elements: [{type: "mrkdwn", text: ($sprint_name + " â€¢ " + $since + " â†’ " + $until)}]},
                {type: "divider"},
                {type: "section", text: {type: "mrkdwn", text: "*ðŸ“Š Sprint Metrics*"}},
                {type: "section", fields: [
                  {type: "mrkdwn", text: ("*Tickets Completed*\\n" + $tickets)},
                  {type: "mrkdwn", text: ("*Story Points*\\n" + $points)},
                  {type: "mrkdwn", text: ("*PRs Merged*\\n" + $prs)},
                  {type: "mrkdwn", text: ("*Lines Changed*\\n" + $lines)}
                ]},
                {type: "divider"},
                {type: "section", text: {type: "mrkdwn", text: ("*ðŸ“¦ Repositories Modified*\\n" + $repos)}},
                {type: "divider"},
                {type: "section", text: {type: "mrkdwn", text: "*ðŸ“Ž Links*"}},
                {type: "section", text: {type: "mrkdwn", text: ("ðŸ“‹ <https://github.com/brighthive/agentic-project-mgmt/blob/master/jira/sprint/" + $sprint_num + "/RELEASE_NOTES.md|Release Notes (Engineering)>\\nðŸ“£ <https://github.com/brighthive/agentic-project-mgmt/blob/master/jira/sprint/" + $sprint_num + "/MARKETING_RELEASE_NOTES.md|Marketing Notes (GTM)>\\nðŸ“Š <https://www.notion.so/2fd02437dde481feb7e2e7b689fc0679|Sprint " + $sprint_num + " Notion Page>\\nðŸŽ¯ <https://brighthiveio.atlassian.net/jira/software/projects/BH/boards|Jira Board>")}}
              ]
            }')

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
