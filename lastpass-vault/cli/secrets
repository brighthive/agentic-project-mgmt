#!/usr/bin/env python3
"""
BrightHive LastPass Vault CLI - Minimal

Commands:
    fetch <name> [field]    # Get secret value (password, username, etc)
    search <query>          # Search secrets
    describe <name>         # Show full secret details
    find <query>            # Alias for search
    status                  # Show catalog status/stats
    sync                    # Fetch from LastPass
    delete <name>           # Delete secret from catalog
"""

import sys
import argparse
from pathlib import Path

# Add lib to path
sys.path.insert(0, str(Path(__file__).parent.parent / "lib"))

from lastpass import LastPassClient
from catalog import SecretsCatalog
from analysis import SecretsAnalyzer
from backup import load_backup_secrets
from app import SecretsApp
from config import load_config
from models import SecretCategory, Environment


def _build_app():
    config = load_config()
    catalog = SecretsCatalog(config.data_dir / "catalog.json")
    analyzer = SecretsAnalyzer()
    return SecretsApp(
        config=config,
        catalog=catalog,
        analyzer=analyzer,
        backup_loader=load_backup_secrets,
        lastpass_client_factory=LastPassClient,
    )


def cmd_fetch(args):
    """Get secret value."""
    app = _build_app()
    results = app.catalog.search(args.name)

    if not results:
        print(f"Secret not found: {args.name}", file=sys.stderr)
        return

    if len(results) > 1:
        print(f"Multiple secrets found ({len(results)}):", file=sys.stderr)
        for i, secret in enumerate(results, 1):
            print(f"  {i}. {secret.name} [{secret.category.value}]", file=sys.stderr)
        return

    secret = results[0]
    field = (args.field or "password").lower()

    if field == "password":
        print(secret.password)
    elif field == "username":
        print(secret.username)
    elif field == "url":
        print(secret.url)
    elif field in ("note", "notes"):
        print(secret.notes)
    else:
        # Try custom field from notes
        for line in secret.notes.splitlines():
            if ":" in line:
                key, value = line.split(":", 1)
                if key.strip().lower() == field:
                    print(value.strip())
                    return
        print(f"Field '{args.field}' not found", file=sys.stderr)


def cmd_search(args):
    """Search secrets."""
    app = _build_app()
    results = app.catalog.search(args.query)

    if not results:
        print(f"No results found for: {args.query}")
        return

    print(f"Found {len(results)} results:\n")
    for secret in results:
        env = f"[{secret.environment.value}]" if secret.environment.value != "unknown" else ""
        print(f"  {secret.name} {env} ({secret.category.value})")


def cmd_describe(args):
    """Show full secret details."""
    app = _build_app()
    results = app.catalog.search(args.name)

    if not results:
        print(f"Secret not found: {args.name}", file=sys.stderr)
        return

    if len(results) > 1:
        print(f"Multiple secrets found ({len(results)}):", file=sys.stderr)
        for i, secret in enumerate(results, 1):
            print(f"  {i}. {secret.name} [{secret.category.value}]", file=sys.stderr)
        return

    secret = results[0]
    print(f"Name: {secret.name}")
    print(f"Category: {secret.category.value}")
    print(f"Environment: {secret.environment.value}")
    print(f"Username: {secret.username}")
    print(f"Password: {secret.password}")
    print(f"URL: {secret.url}")
    if secret.instance:
        print(f"Instance: {secret.instance}")
    if secret.purpose:
        print(f"Purpose: {secret.purpose}")
    if secret.notes:
        print(f"Notes: {secret.notes}")


def cmd_status(args):
    """Show catalog status."""
    app = _build_app()
    stats = app.catalog.get_stats()

    print(f"Total: {stats['total']} secrets")
    print(f"Duplicates: {stats['duplicates']}")
    print(f"Deprecated: {stats['deprecated']}")
    
    if stats['by_category']:
        print("\nBy Category:")
        for cat, count in sorted(stats['by_category'].items()):
            print(f"  {cat}: {count}")
    
    if stats['by_environment']:
        print("\nBy Environment:")
        for env, count in sorted(stats['by_environment'].items()):
            print(f"  {env}: {count}")


def cmd_sync(args):
    """Sync from LastPass."""
    app = _build_app()
    print("Syncing from LastPass...")
    secrets = app.export_lastpass()
    
    for secret in secrets:
        app.catalog.add(secret)
    
    app.catalog.save()
    print(f"Synced {len(secrets)} secrets")


def cmd_delete(args):
    """Delete secret from catalog."""
    app = _build_app()
    results = app.catalog.search(args.name)

    if not results:
        print(f"Secret not found: {args.name}", file=sys.stderr)
        return

    if len(results) > 1:
        print(f"Multiple secrets found ({len(results)}):", file=sys.stderr)
        for i, secret in enumerate(results, 1):
            print(f"  {i}. {secret.name} [{secret.category.value}]", file=sys.stderr)
        return

    secret = results[0]
    if args.name in app.catalog.secrets:
        del app.catalog.secrets[secret.id]
        app.catalog.save()
        print(f"Deleted: {secret.name}")
    else:
        print(f"Secret not found in catalog", file=sys.stderr)


def main():
    """Main CLI entry point."""
    parser = argparse.ArgumentParser(
        description="LastPass Vault - Minimal CLI",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # Fetch
    fetch_parser = subparsers.add_parser("fetch", help="Get secret value")
    fetch_parser.add_argument("name", help="Secret name")
    fetch_parser.add_argument("field", nargs="?", default="password", help="Field (password, username, url)")

    # Search
    search_parser = subparsers.add_parser("search", help="Search secrets")
    search_parser.add_argument("query", help="Search query")

    # Describe
    describe_parser = subparsers.add_parser("describe", help="Show full secret details")
    describe_parser.add_argument("name", help="Secret name")

    # Find (alias for search)
    find_parser = subparsers.add_parser("find", help="Find secrets (alias for search)")
    find_parser.add_argument("query", help="Search query")

    # Status
    subparsers.add_parser("status", help="Show catalog status")

    # Sync
    subparsers.add_parser("sync", help="Sync from LastPass")

    # Delete
    delete_parser = subparsers.add_parser("delete", help="Delete secret from catalog")
    delete_parser.add_argument("name", help="Secret name")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return

    commands = {
        "fetch": cmd_fetch,
        "search": cmd_search,
        "describe": cmd_describe,
        "find": cmd_search,  # Alias
        "status": cmd_status,
        "sync": cmd_sync,
        "delete": cmd_delete,
    }

    commands[args.command](args)


if __name__ == "__main__":
    main()
